.global fe25519_mul121666
.type fe25519_mul121666, @function

; operand b: r21:r20
; operand a: r23:r22
; operand r: r25:r24


fe25519_mul121666:

PUSH R8

MOVW R30, R24
MOVW R26, R22

CLR R8 ; zero register

LDI R18, 0x42
LDI R19, 0xdb

LD R21, X+ ;x0

MUL R18,R21
ST Z+, R0    ; r0
MOV R22, R1

MUL R19,R21
ADD R22, R0
MOV R23, R21
ADC R23, R1
CLR R24
ADC R24,R24
LD R21, X+ ;x1

MUL R18,R21
ADD R22,R0
ADC R23,R1
ADC R24,R8
ST Z+, R22  ;r1

MUL R19,R21
ADD R23,R0
ADC R24,R1
ADD R24,R21
CLR R22
ADC R22,R8


LDI R25,9

loop:

  LD R21, X+ ;x1
  
  MUL R18,R21
  ADD R23,R0
  ADC R24,R1
  ADC R22,R8
  ST Z+, R23  ;r1
  
  MUL R19,R21
  ADD R24,R0
  ADC R22,R1
  ADD R22,R21
  CLR R23
  ADC R23,R8
  
  
  LD R21, X+ ;x1
  
  MUL R18,R21
  ADD R24,R0
  ADC R22,R1
  ADC R23,R8
  ST Z+, R24  ;r1
  
  MUL R19,R21
  ADD R22,R0
  ADC R23,R1
  ADD R23,R21
  CLR R24
  ADC R24,R8
  
  
  LD R21, X+ ;x1
  
  MUL R18,R21
  ADD R22,R0
  ADC R23,R1
  ADC R24,R8
  ST Z+, R22  ;r1
  
  MUL R19,R21
  ADD R23,R0
  ADC R24,R1
  ADD R24,R21
  CLR R22
  ADC R22,R8
  
DEC R25
BRNE loop


LD R21, X+ ;x1

MUL R18,R21
ADD R23,R0
ADC R24,R1
ADC R22,R8
ST Z+, R23  ;r1

MUL R19,R21
ADD R24,R0
ADC R22,R1
ADD R22,R21
CLR R23
ADC R23,R8


LD R21, X+ ;x1

MUL R18,R21
ADD R24,R0
ADC R22,R1
ADC R23,R8
ST Z+, R24  ;r1

MUL R19,R21
ADD R22,R0
ADC R23,R1
ADD R23,R21
CLR R24
ADC R24,R8


LD R21, X+ ;x1

MUL R18,R21
ADD R22,R0
ADC R23,R1
ADC R24,R8

MUL R19,R21
ADD R23,R0
ADC R24,R1
ADD R24,R21
MOV R18, R22
LDI R19, 0x7f
AND R22, R19
ST Z+, R22  ;r31

CLR R22
ADC R22,R8

LSL R18
ROL R23
ROL R24
ROL R22

LDI R18,19

MUL R23,R18
MOV R23,R0 ; c0
MOV R19,R1

MUL R24,R18
ADD R19,R0 ; c1
CLR R24
ADC R24,R1

MUL R22,R18
ADD R24,R0 ; c2

SBIW R30,0x20

LD R18,Z
ADD R18,R23
ST Z+,R18

LD R18,Z
ADC R18,R19
ST Z+,R18

LD R18,Z
ADC R18,R24
ST Z+,R18


LDI R25,29

cloop:

  LD R18,Z
  ADC R18,R8
  ST Z+,R18

DEC R25
BRNE cloop


CLR R1 ; R1 is already 0, but we leave this in for clarity
POP R8
RET
